# 网站接入Cloudflare后静态资源加载失败问题

> Author : laeo

> Date   : 2019/03/17

> License: CC BY-NC-SA 3.0

## 发现问题

将一个新建的图片站接入了 Cloudflare，可是访问后却发现页面不正常，就是静态资源没有加载成功一样。网站系统基于 Django 框架开发，通过 uwsgi 在容器中部署，静态资源也是通过框架在管理，本以为是配置出错导致的 404 错误，结果手动访问静态资源却是正常的。

迷一般的问题……

打开控制台，发现打印出了几个类似的错误，大概就是

```
指向 "/static/js/app.js" 的 <script> 加载失败。
```

这个样子的错误信息，刷新了页面，通过网络记录发现出现错误的静态文件的 mime 类型都是 `application/x-unknown-type-content`，就很奇怪了，记忆中浏览器会自动通过文件内容猜测其类型才对，就算没有类型也不会出现这种问题的。

于是又搜索了下相关资料，发现有提到 CSP 这个词，在 MDN 看了相关文档，发现并不是该设置的问题。于是找了一个报未知文件类型的请求记录，一一查看其响应的头信息。在其中找到了 `X-Content-Type-Options: nosniff` 这个指令，查了下其资料后得知，这指令会`导致浏览器停止类型探测`，我想就是它了。

## 解决问题

知道可能是什么原因导致的问题就好，跑到 CF 的网站仔细找了下，最后在 HSTS 设置引导中找到了相关的设置。在停用了该特性之后，网站恢复正常加载。

技术发展日新月异，稍微慢一点，就会让头发少几根，想想还是痛苦。