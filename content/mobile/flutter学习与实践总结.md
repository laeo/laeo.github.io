---
title: 'Flutter学习与实践总结'
date: 2020-09-11
license: CC BY-NC-SA 3.0
---

## 闲言

Flutter 可以说在开发者圈子还是很有名的了，毕竟是谷歌，关注度自不必说。我很早就有心涉足移动 APP 开发，但是学习了一段时间的安卓开发后，实在忍受不了 JAVA 那种类中套类的套娃写法（也可能是没学对吧），后面就没坚持下去。做过一段时间的小程序开发后，又让我燃起了对原生移动端的热情，于是我打开了 Flutter 的官网……

## 学习记录

学习方法很重要，对于我这个大部分靠自学的人而言，最好的办法肯定就是先速览一遍文档，对要学习的内容有个大致的印象，然后跟着教程挨个阅读、实践，增强对细节的记忆与理解。

#### 安装 Flutter

我用的是 Mac，所以安装时走的包管理器，并没有依照文档中那样下载二进制文件。所以总的来说安装还是很简单的，首先 `brew install flutter` ，安装好二进制，然后执行 `flutter docter` 检查环境及依赖。

无论使用什么编辑器编写代码，**Android Studio** 以及 **Xcode** 都是必须的，为了方便调试，还需要创建各平台的虚拟机。对于我来说，**VSCode** 搭配 Flutter 相关的插件就已经满足开发调试的需要，而且还可以直接吊起双端的虚拟机进行调试，简直方便到不行。

#### Dart 与 Widget

了解 Flutter 的都知道，谷歌为它选择了一门冷门语言 —— Dart。这门语言对于熟悉 JS 和 TS 的人来说，上手难度不大。入口函数 `void main()` 、类、接口、范型、异步，主要是看下异步那块的文档，其它的都大同小异。Widget 的话，类似 Vue 和 React 里的组件，Flutter 渲染界面就是通过我们传递给 `runApp()` 函数的组件实例开始的，所以我们开发时会经常跟各种 Widget 打交道。

Flutter 把 Widget 分为两种类型，即 **StatefullWidget** 和 **StatelessWidget**，我们要创建自定义的组件，也是通过继承这两个组件类来完成的。看到 `Statefull` 和 `Stateless` ，如果熟悉 Kubernetes 的话，一定会有所联想。确实，与 K8S 中的定义类似，它们也是用于区分组件自身是否需要维护一个状态的，具体两种组件在渲染时有何差异，我还并未去了解，想来应该是用于拆分代码结构、确定组件是否需要重建用的吧。

另外，需要注意的是，虽然 runApp() 函数接收一个组件，但不代表组件就是被渲染到屏幕上的具体元素。按文档所言，Widget 主要是用来存储渲染结果的配置信息的，也就是说它只是个配置信息容器。实际代表渲染结果的，是 Element 类实例。Widget 中的配置信息，决定了 Element 最终以何等形式显示在屏幕上。另外，Widget 中的 build 方法所接收的参数 context，实际上就是 Element 的实例。

#### 布局与排版

Flutter 提供了类似现代 Web 形式的布局与排版方式，比如熟悉的 Flex 布局系统，还有基于 Flex 布局的 `Row` 和 `Column` 组件，简直不要太方便。对于展示需要垂直或者水平滚动的内容，Flutter 内置了 `SingleChildScrollViewWidget` 、 `MultiChildScrollViewWidget` 两个组件，还有如 `Container`  `Stack`  `Positioned`  `Expanded`  `Text` 之类的组件，轻松处理各种布局。

#### 样式

谷歌出品，必须质感。**Material** 不出意外的成为默认设计风格，当然为了兼容苹果设备，谷歌另外提供了一套风格组件 **Cupertino**。当然现代移动 APP 应用都很难说清自己用了什么风格，或许都沾一点，也不要紧，自己动手修改组件的参数就行。

#### Canvas

为啥要单独提出来说呢？因为它给我的印象最深。我练手写的 APP，是一款图片加水印的 APP，用于各种证件照片打水印。Flutter 没有内置的操作处理图片的库，也没有找到相关的三方库，唯一找到的一个 **image** 还因为各种原因不适用。所以找来找去，找到了 `CustomPaint` ，因为要实时预览最终的图片效果，所以只能自己写一个 `CustomPainter` 来实现图片打水印的逻辑。

说起这个 CustomPaint Widget，那就不知道要说些啥了，反正很强大，搭配自定义的 CustomPainter，可以为用户呈现任意图形，甚至是动画。而其依赖的 CustomPainter 实现，则是通过 **Canvas** 来达到构造任意图形的功能，只是由于 Canvas 的 API 设计没有对象化，所以用起来还是挺烧脑的，特别是我这种没有过 Canvas 绘制经验的人……

## 槽点

由于我没做过原生相关开发，所以某些观点可能存在差错。

#### 系统权限

这一点说实话 Flutter 没做好，依然还要手动修改原生配置文件来申请权限，虽然有一个开源的库可以辅助，但仍需要手动修改配置。按我所设想，它完全可以用配置文件加代码生成的方式，来达成权限申请的统一管理，隔离开发者与原生配置文件。

#### 本地化

Flutter 的本地化，并没有包括应用在启动器里的名字，让我很差异……其实也可以通过代码生成的方式来处理这个问题。

#### 各种库缺失

可能是因为 Dart 这个语言的定位问题，Flutter 的各种库（比如图片、视频）都是依靠第三方开发，没有自己实现的。这意味着不稳定、更新不及时、兼容性无法保证等问题。比如我找一个将图片保存到系统相册的库，尝试了好几个都不行，有的是权限问题，有的是原生代码老旧，最后还是找了一个别人修改过的版本，才能正常使用。

## 水印 APP

我开发的 APP 已开源，地址是 [laeo/flutter-watermark](https://github.com/laeo/flutter-watermark)。大致的逻辑就是自定义 CustomPainter 根据传入的参数绘制水印图，画布的大小根据传入的 `Size` 来定。当用于界面展示时就根据容器宽度，保持与图片相同宽高比计算画布的宽高，图片使用 `BoxFit.cover` 约束填充到画布上。而当用户点击保存按钮时，传入的 `Size` 直接使用图片本身的宽高，以保证清晰度。

## 总结

就目前我的开发体验来说，Flutter 的路还很长，虽然现在有部分公司开始使用，特别是像咸鱼团队这种主推它的，可依然无法避免开发过程中需要与原生打交道的时候。对于开发一些小型的 APP，或者技术团队足够强的企业，或许会省事一些，希望以后会更加完善吧。
